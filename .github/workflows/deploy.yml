name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          password: ${{ secrets.PROD_PASSWORD }}
          port: ${{ secrets.PROD_PORT || '22' }}
          script: |
            set -e  # Fail immediately if any command returns a non-zero status
            echo "ğŸš€ Starting Deployment..."

            # 1. Navigate to project directory (or create if missing)
            PROJECT_DIR="$HOME/tr2-reptes-tr2_grup7"
            echo "ğŸ“‚ Target Directory: $PROJECT_DIR"

            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ“‚ Cloning repository..."
              git clone https://github.com/inspedralbes/tr2-reptes-tr2_grup7.git "$PROJECT_DIR"
            fi

            cd "$PROJECT_DIR"

            # 2. Pull latest changes
            echo "â¬‡ï¸ Pulling latest changes..."
            git pull origin main

            # 3. Create/Update .env file from Secrets
            echo "ğŸ“ Updating .env file..."
            cat <<EOF > .env
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            PORT_DATABASE=5432
            PORT_BACKEND=3000
            PORT_FRONTEND=80
            DATABASE_URL=postgres://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@db:5432/${{ secrets.POSTGRES_DB }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            VITE_API_URL=${{ secrets.VITE_API_URL }}
            EOF

            # 4. Clean slate deployment
            echo "ğŸ§¹ Cleaning up..."
            # Try proper down first (for current project context)
            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            # Force remove specific named containers in case they belong to a different project context
            docker rm -f postgres_prod backend_prod frontend_prod certbot 2>/dev/null || true

            # 5. Build and Start new containers
            echo "ğŸ—ï¸ Building and Starting containers..."
            docker compose -f docker-compose.prod.yml up --build -d

            echo "âœ… Deployment Successful!"
