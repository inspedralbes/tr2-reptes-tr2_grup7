name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          password: ${{ secrets.PROD_PASSWORD }}
          port: ${{ secrets.PROD_PORT || '22' }}
          script: |
            echo "üöÄ Starting Deployment..."

            # 1. Navigate to project directory (or create if missing)
            PROJECT_DIR="~/tr2-reptes-tr2_grup7"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "üìÇ Cloning repository..."
              git clone https://github.com/inspedralbes/tr2-reptes-tr2_grup7.git "$PROJECT_DIR"
            fi

            cd "$PROJECT_DIR"

            # 2. Pull latest changes
            echo "‚¨áÔ∏è Pulling latest changes..."
            git pull origin main

            # 3. Create/Update .env file from Secrets
            echo "üìù Updating .env file..."
            cat <<EOF > .env
            POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            PORT_DATABASE=5432
            PORT_BACKEND=3000
            PORT_FRONTEND=80
            DATABASE_URL=postgres://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@db:5432/${{ secrets.POSTGRES_DB }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            VITE_API_URL=${{ secrets.VITE_API_URL }}
            EOF

            # 4. Stop and Remove old containers (optional but safe)
            # echo "üõë Stopping old containers..."
            # docker compose -f docker-compose.prod.yml down

            # 5. Build and Start new containers
            echo "üèóÔ∏è Building and Starting containers..."
            docker compose -f docker-compose.prod.yml up --build -d

            echo "‚úÖ Deployment Successful!"
